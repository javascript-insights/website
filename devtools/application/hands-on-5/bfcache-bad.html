<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BFCache Bad Page</title>
    <link rel="icon" type="image/png" href="/static/favicon.png" />
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 700px; margin: 40px auto; padding: 20px; background: #fef8f8; color: #333; }
        h1 { color: #c62828; margin-bottom: 10px; }
        .badge { display: inline-block; background: #ef5350; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 20px; }
        .info { background: #ffebee; border-left: 4px solid #ef5350; padding: 16px; border-radius: 6px; margin-bottom: 20px; }
        .controls { background: #fff; border: 2px solid #ffcdd2; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .controls h3 { margin-bottom: 12px; }
        .toggle-row { display: flex; align-items: center; gap: 12px; margin: 10px 0; }
        .toggle-row label { font-weight: 500; }
        .status { font-size: 0.85rem; padding: 3px 10px; border-radius: 10px; }
        .status.on { background: #ffcdd2; color: #c62828; }
        .status.off { background: #e8f5e9; color: #2e7d32; }
        .counter-box { background: #fff; border: 2px solid #ffcdd2; border-radius: 10px; padding: 24px; text-align: center; margin: 20px 0; }
        .counter { font-size: 3rem; font-weight: bold; color: #c62828; }
        .timer { font-size: 1.2rem; color: #666; margin-top: 8px; }
        button { background: #ef5350; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1rem; margin: 5px; }
        button:hover { background: #c62828; }
        button.secondary { background: #78909c; }
        .log { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 8px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto; margin-top: 20px; white-space: pre-wrap; }
        .back-link { display: inline-block; margin-top: 20px; color: #c62828; }
    </style>
</head>
<body>
    <h1>‚ùå BFCache-Incompatible Page</h1>
    <span class="badge">Should NOT be cached</span>

    <div class="info">
        <strong>This page has bfcache blockers.</strong><br>
        Toggle the blockers below and observe how they affect caching in DevTools ‚Üí Application ‚Üí Back/forward cache.
    </div>

    <div class="controls">
        <h3>BFCache Blockers</h3>
        <div class="toggle-row">
            <button id="toggleBeforeunload">Toggle beforeunload</button>
            <label>Status:</label>
            <span class="status off" id="beforeunloadStatus">OFF</span>
        </div>
        <div class="toggle-row">
            <button id="toggleWebsocket">Toggle WebSocket</button>
            <label>Status:</label>
            <span class="status off" id="websocketStatus">OFF</span>
        </div>
    </div>

    <div class="counter-box">
        <div>Click counter:</div>
        <div class="counter" id="counter">0</div>
        <div class="timer" id="timer">Timer: 0s</div>
        <button id="incrementBtn">Count +1</button>
        <button id="resetBtn" class="secondary">Reset</button>
    </div>

    <p><strong>Exercise:</strong> Enable one or both blockers, click the counter, then navigate away and press Back. The counter will reset (bfcache wasn't used). Compare with the Good page!</p>

    <a href="./index.html" class="back-link">‚Üê Back to Hands-On 5</a>
    <br>
    <a href="./bfcache-good.html" class="back-link">Go to BFCache-GOOD page ‚Üí</a>

    <div class="log" id="log"></div>

    <script>
        let count = 0;
        let seconds = 0;
        let timerInterval;
        let beforeunloadActive = false;
        let ws = null;
        const counterEl = document.getElementById('counter');
        const timerEl = document.getElementById('timer');
        const logEl = document.getElementById('log');
        const buStatus = document.getElementById('beforeunloadStatus');
        const wsStatus = document.getElementById('websocketStatus');

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.textContent += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Counter
        document.getElementById('incrementBtn').addEventListener('click', () => {
            count++;
            counterEl.textContent = count;
            log('Counter: ' + count);
        });
        document.getElementById('resetBtn').addEventListener('click', () => {
            count = 0;
            counterEl.textContent = 0;
            log('Counter reset');
        });

        // Timer
        timerInterval = setInterval(() => {
            seconds++;
            timerEl.textContent = 'Timer: ' + seconds + 's';
        }, 1000);

        // beforeunload blocker
        function beforeunloadHandler(e) {
            e.preventDefault();
            e.returnValue = '';
        }

        document.getElementById('toggleBeforeunload').addEventListener('click', () => {
            beforeunloadActive = !beforeunloadActive;
            if (beforeunloadActive) {
                window.addEventListener('beforeunload', beforeunloadHandler);
                buStatus.textContent = 'ON';
                buStatus.className = 'status on';
                log('‚õî beforeunload listener ADDED ‚Äî bfcache blocked');
            } else {
                window.removeEventListener('beforeunload', beforeunloadHandler);
                buStatus.textContent = 'OFF';
                buStatus.className = 'status off';
                log('‚úÖ beforeunload listener REMOVED');
            }
        });

        // WebSocket blocker
        document.getElementById('toggleWebsocket').addEventListener('click', () => {
            if (ws) {
                ws.close();
                ws = null;
                wsStatus.textContent = 'OFF';
                wsStatus.className = 'status off';
                log('‚úÖ WebSocket CLOSED');
            } else {
                try {
                    ws = new WebSocket('wss://echo.websocket.org');
                    ws.addEventListener('open', () => {
                        wsStatus.textContent = 'ON';
                        wsStatus.className = 'status on';
                        log('‚õî WebSocket OPENED ‚Äî bfcache blocked');
                    });
                    ws.addEventListener('error', () => {
                        wsStatus.textContent = 'ON (error)';
                        wsStatus.className = 'status on';
                        log('‚õî WebSocket connection error (still blocks bfcache)');
                    });
                    ws.addEventListener('close', () => {
                        ws = null;
                        wsStatus.textContent = 'OFF';
                        wsStatus.className = 'status off';
                        log('WebSocket closed by server');
                    });
                } catch (e) {
                    log('WebSocket error: ' + e.message);
                }
            }
        });

        // pageshow
        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                log('üéâ Restored from bfcache (unexpected with blockers active!)');
            } else {
                log('Page loaded normally (NOT from bfcache)');
            }
        });

        log('Page initialized. Toggle blockers, click counter, navigate away, then press Back.');
        log('With blockers ON, the counter should reset (page was NOT cached).');
    </script>
</body>
</html>
